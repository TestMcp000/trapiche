# Embeddings & Semantic Search (pgvector) â€” Technical Spec

> Status: Stable  
> Last Updated: 2026-01-02  
> Note: this is the canonical technical spec; design rationale lives in `SUPABASE_AI.md`.

Links:

- Implemented behavior (SSoT): `../../SPEC.md#embeddings-and-semantic-search-admin-only`
- PRD / design rationale: `SUPABASE_AI.md`

---

## 1. pgvector èƒ½åŠ›èªªæ˜

### 1.1 ä»€éº¼æ˜¯ pgvectorï¼Ÿ

pgvector æ˜¯ PostgreSQL çš„æ“´å±•ï¼Œè®“è³‡æ–™åº«èƒ½å¤ ï¼š

1. **å„²å­˜å‘é‡**ï¼šä¸€ä¸²æµ®é»æ•¸ï¼ˆä¾‹å¦‚ 1536 ç¶­åº¦ï¼‰
2. **æœå°‹ç›¸ä¼¼å‘é‡**ï¼šæ‰¾å‡ºèªæ„æœ€æ¥è¿‘çš„è³‡æ–™
3. **å»ºç«‹ç´¢å¼•**ï¼šåŠ é€Ÿç›¸ä¼¼åº¦æœå°‹

### 1.2 ä»€éº¼æ˜¯ Embeddingï¼ˆå‘é‡ï¼‰ï¼Ÿ

Embedding æ˜¯ç”¨æ•¸å­—è¡¨ç¤ºå…§å®¹ã€Œæ„ç¾©ã€çš„æ–¹æ³•ï¼š

```
ã€Œè¼•ä¾¿å¥½æ”œå¸¶çš„åŒ…åŒ…ã€ â†’ [0.12, -0.34, 0.56, ..., 0.78]  # 1536 å€‹æ•¸å­—
ã€Œéš¨èº«å°åŒ…ã€         â†’ [0.11, -0.32, 0.58, ..., 0.76]  # å¾ˆç›¸è¿‘ï¼
ã€Œé‡å‹æ©Ÿè»Šã€         â†’ [-0.45, 0.23, -0.12, ..., 0.34] # å¾ˆä¸åŒ
```

èªæ„ç›¸è¿‘çš„æ–‡å­—ï¼Œå‘é‡ä¹Ÿæœƒç›¸è¿‘ï¼ˆå‘é‡è·é›¢å°ï¼‰ã€‚

### 1.3 èƒ½åšä»€éº¼

| èƒ½åŠ›           | èªªæ˜                             | æ‡‰ç”¨å ´æ™¯                               |
| -------------- | -------------------------------- | -------------------------------------- |
| **èªæ„æœå°‹**   | ç”¨è‡ªç„¶èªè¨€æœå°‹ï¼Œä¸éœ€è¦ç²¾ç¢ºé—œéµå­— | ç”¨æˆ¶æœã€Œè¼•ä¾¿å¥½æ”œå¸¶ã€â†’ æ‰¾åˆ°ã€Œæ‘ºç–Šæ°´å£ºã€ |
| **ç›¸ä¼¼åº¦åŒ¹é…** | æ‰¾å‡ºå…§å®¹æœ€ç›¸ä¼¼çš„é …ç›®             | å•†å“è©³æƒ…é çš„ã€Œç›¸ä¼¼å•†å“ã€               |
| **RAG æª¢ç´¢**   | ç‚º AI åˆ†ææä¾›ç›¸é—œä¸Šä¸‹æ–‡         | åˆ†æéŠ·å”®è¶¨å‹¢æ™‚ï¼Œè‡ªå‹•æ‰¾ç›¸é—œè¨‚å–®         |
| **æ™ºèƒ½åˆ†é¡**   | æ ¹æ“šèªæ„è‡ªå‹•æ­¸é¡                 | åµæ¸¬é‡è¤‡å•†å“ã€ç›¸ä¼¼æ–‡ç«                  |
| **å¢é›†åˆ†æ**   | æ‰¾å‡ºè³‡æ–™ä¸­çš„ç¾¤çµ„                 | ç™¼ç¾å•†å“çš„è‡ªç„¶åˆ†é¡                     |

### 1.4 ä¸èƒ½åšä»€éº¼

| é™åˆ¶            | åŸå›                        | æ›¿ä»£æ–¹æ¡ˆ                            |
| --------------- | -------------------------- | ----------------------------------- |
| âŒ ç†è§£åœ–ç‰‡å…§å®¹ | åªèƒ½è™•ç†æ–‡å­—               | å…ˆç”¨åœ–ç‰‡ AI ç”Ÿæˆæè¿°ï¼Œå† embed æè¿° |
| âŒ è‡ªå·±ç”Ÿæˆå‘é‡ | éœ€è¦å¤–éƒ¨ Embedding API     | ä½¿ç”¨ OpenAI ada-002 æˆ–å…¶ä»–æ¨¡å‹      |
| âŒ è‡ªæˆ‘å­¸ç¿’æ”¹é€² | ä¸æ˜¯æ©Ÿå™¨å­¸ç¿’æ¨¡å‹           | äººå·¥èª¿æ•´æˆ–é‡æ–° embed                |
| âŒ å³æ™‚è¨“ç·´     | å‘é‡æ˜¯éœæ…‹çš„               | å…§å®¹æ›´æ–°æ™‚é‡æ–°ç”Ÿæˆ                  |
| âŒ ç†è§£æœ€æ–°è³‡è¨Š | Embedding æ¨¡å‹æœ‰è¨“ç·´æˆªæ­¢æ—¥ | ä½¿ç”¨æŒçºŒæ›´æ–°çš„æ¨¡å‹                  |

### 1.5 æˆæœ¬ä¼°ç®—

| é …ç›®                              | æˆæœ¬                 | èªªæ˜                |
| --------------------------------- | -------------------- | ------------------- |
| **Supabase pgvector**             | $0ï¼ˆPro æ–¹æ¡ˆå·²åŒ…å«ï¼‰ | ç„¡é¡å¤–è²»ç”¨          |
| **OpenAI text-embedding-ada-002** | $0.0001 / 1K tokens  | ç´„ 500 tokens/ç­†    |
| **OpenAI text-embedding-3-small** | $0.00002 / 1K tokens | æ›´ä¾¿å®œï¼Œæ•ˆæœæ¥è¿‘    |
| **å„²å­˜ç©ºé–“**                      | æ¯ç­†ç´„ 6KB           | 1536 ç¶­åº¦ Ã— 4 bytes |

**ä¼°ç®—ä½ çš„ç¶²ç«™**ï¼š

å‡è¨­ï¼š100 ç¯‡æ–‡ç«  + 50 å€‹å•†å“ + 500 å‰‡ç•™è¨€ = 650 ç­†

- é¦–æ¬¡å»ºç«‹å…¨éƒ¨ embeddingï¼šç´„ $0.30 USD
- æ¯æœˆæ–°å¢ 50 ç­†ï¼šç´„ $0.03 USD

---

## 2. Embedding å…§å®¹ç­–ç•¥

### 2.1 è¨­è¨ˆåŸå‰‡

- **é›†ä¸­å¼è¨­è¨ˆ**ï¼šä¸€å¼µè¡¨å­˜æ‰€æœ‰ embeddingï¼Œæ¥­å‹™è¡¨ä¸ç”¨æ”¹ schema
- **é›™èªåˆä½µ**ï¼šä¸­è‹±æ–‡å…§å®¹åˆä½µï¼Œè®“æœå°‹åŒæ™‚æ”¯æ´å…©ç¨®èªè¨€
- **ç²¾ç°¡å…§å®¹**ï¼šåªå–èªæ„ç›¸é—œçš„æ¬„ä½ï¼Œä¸éœ€å®Œæ•´å…§å®¹

### 2.1.1 Embeddings è¡¨è¨­è¨ˆ

> **æ±ºç­–**: å¾ Phase 1 é–‹å§‹å³æ”¯æ´ Chunkingï¼Œå› ç•¶å‰ DB ç‚ºç©ºä¸”æœªä¸Šç·šï¼Œä¸éœ€ç¶­è­·å‘å¾Œç›¸å®¹ã€‚

```sql
CREATE TABLE embeddings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  target_type VARCHAR(50) NOT NULL,  -- 'product' | 'post' | 'gallery_item' | 'comment'
  target_id UUID NOT NULL,
  chunk_index INT DEFAULT 0,          -- ç¬¬å¹¾å€‹ chunkï¼ˆ0 = å–®ä¸€/å®Œæ•´å…§å®¹ï¼‰
  chunk_total INT DEFAULT 1,          -- ç¸½å…±å¹¾å€‹ chunks
  embedding vector(1536) NOT NULL,
  content_hash VARCHAR(64) NOT NULL,  -- SHA256 of input text (for change detection)
  chunk_content TEXT,                 -- è©² chunk çš„åŸå§‹å…§å®¹ï¼ˆä¾› debugï¼‰
  preprocessing_metadata JSONB,       -- å‰è™•ç† metadata
  enrichment_metadata JSONB,          -- è±å¯ŒåŒ– metadata
  quality_status VARCHAR(20) DEFAULT 'passed',  -- passed, incomplete, failed
  quality_score DECIMAL(3,2),         -- å“è³ªåˆ†æ•¸ 0.00-1.00
  quality_check_at TIMESTAMPTZ,       -- æœ€å¾Œå“è³ªæª¢æŸ¥æ™‚é–“
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),

  UNIQUE(target_type, target_id, chunk_index)
);

CREATE INDEX ON embeddings USING ivfflat (embedding vector_cosine_ops);
CREATE INDEX idx_embeddings_target ON embeddings(target_type, target_id);
CREATE INDEX idx_embeddings_quality ON embeddings(quality_status, quality_score);
```

**æ¬„ä½èªªæ˜**ï¼š

| æ¬„ä½                                          | ç”¨é€”                                                 |
| --------------------------------------------- | ---------------------------------------------------- |
| `content_hash`                                | å…§å®¹é›œæ¹Šï¼Œç”¨æ–¼åµæ¸¬å…§å®¹æ˜¯å¦è®Šæ›´ï¼ˆé¿å…ç„¡è¬‚é‡å»ºï¼‰       |
| `target_type` + `target_id` + `chunk_index`   | è¤‡åˆå”¯ä¸€ç´¢å¼•ï¼Œä¸€ç­†æ¥­å‹™è³‡æ–™å¯æœ‰å¤šå€‹ chunks            |
| `chunk_index` / `chunk_total`                 | Chunk ç´¢å¼•èˆ‡ç¸½æ•¸ï¼Œæ”¯æ´é•·æ–‡ç« åˆ‡ç‰‡                     |
| `quality_status` / `quality_score`            | å“è³ªæª¢æŸ¥çµæœï¼Œç”¨æ–¼ RAG æª¢ç´¢æ™‚éæ¿¾ä½å“è³ª chunks       |
| `preprocessing_metadata` / `enrichment_metadata` | Pipeline è™•ç†éç¨‹çš„å…ƒè³‡æ–™ï¼Œä¾› debug èˆ‡ç›£æ§ä½¿ç”¨    |

### 2.2 å„è³‡æ–™é¡å‹çš„ Embedding æ¬„ä½

| è³‡æ–™é¡å‹         | çµ„åˆæ¬„ä½                                              | ç¯„ä¾‹                                                                                               |
| ---------------- | ----------------------------------------------------- | -------------------------------------------------------------------------------------------------- |
| **Product**      | name + description_en + description_zh + tags         | "Handmade Leather Bag æ‰‹å·¥çš®é©åŒ… A beautiful handmade bag... ç²¾ç¾æ‰‹å·¥åŒ…... leather, handmade, bag" |
| **Post**         | title_en + title_zh + excerpt_en + excerpt_zh         | "My First Post æˆ‘çš„ç¬¬ä¸€ç¯‡æ–‡ç«  Introduction to... ä»‹ç´¹..."                                          |
| **Gallery Item** | title_en + title_zh + description_en + description_zh | "Sunset Photography å¤•é™½æ”å½± Captured at... æ‹æ”æ–¼..."                                             |
| **Comment**      | contentï¼ˆå–®ä¸€èªè¨€ï¼‰                                   | "This product is amazing! Love the quality."                                                       |

### 2.3 é‡è¦æ±ºç­–

| é …ç›®              | æ±ºå®š             | åŸå›                                  |
| ----------------- | ---------------- | ------------------------------------ |
| **Post å…§å®¹**     | åªå–æ¨™é¡Œ + æ‘˜è¦  | æ–‡ç« å…§å®¹å¯èƒ½å¾ˆé•·ï¼Œæ‘˜è¦å·²è¶³å¤ è¡¨é”èªæ„ |
| **HTML/Markdown** | ç§»é™¤æ¨™ç±¤         | æ¨™ç±¤å¹²æ“¾èªæ„ç†è§£                     |
| **ç©ºå€¼è™•ç†**      | è·³éç©ºæ¬„ä½       | é¿å…ç„¡æ„ç¾©çš„ç©ºç™½                     |
| **è¨‚å–®è³‡æ–™**      | ä¸å»ºç«‹ embedding | éš±ç§è€ƒé‡ + çµæ§‹åŒ–è³‡æ–™é©åˆå‚³çµ±æŸ¥è©¢    |

### 2.4 ä¸å»ºç«‹ Embedding çš„è³‡æ–™

| è³‡æ–™é¡å‹         | åŸå›                               |
| ---------------- | --------------------------------- |
| Orders           | çµæ§‹åŒ–è³‡æ–™ï¼Œç”¨å‚³çµ± SQL æŸ¥è©¢æ›´åˆé© |
| Members          | éš±ç§è€ƒé‡                          |
| Coupons          | çµæ§‹åŒ–è³‡æ–™                        |
| Site Content     | å›ºå®šå€å¡Šï¼Œä¸éœ€èªæ„æœå°‹            |
| Landing Sections | å›ºå®šå€å¡Šï¼Œä¸éœ€èªæ„æœå°‹            |

### 2.5 ç•™è¨€ Embedding å»ºç«‹è¦å‰‡

| ç•™è¨€ç‹€æ…‹                       | å»ºç«‹ Embedding     | èªªæ˜                              |
| ------------------------------ | ------------------ | --------------------------------- |
| `is_approved: true`            | âœ“ å³æ™‚å»ºç«‹         | æ­£å¸¸ç•™è¨€                          |
| `is_approved: false`ï¼ˆå¾…å¯©æ ¸ï¼‰ | âœ— æš«ä¸å»ºç«‹         | å¯©æ ¸é€šéå¾Œè§¸ç™¼å»ºç«‹                |
| `spam_status: spam`            | âœ— ä¸å»ºç«‹           | åƒåœ¾ç•™è¨€ä¸éœ€èªæ„æœå°‹              |
| å¯©æ ¸é€šéæ™‚                     | âœ“ è§¸ç™¼å»ºç«‹         | `is_approved` å¾ false è®Š true æ™‚ |
| ç•™è¨€åˆªé™¤æ™‚                     | åˆªé™¤å°æ‡‰ embedding | åŒæ­¥æ¸…ç†                          |

---

## 3. åŠŸèƒ½è¦æ ¼

### 3.1 èªæ„æœå°‹

**ä½¿ç”¨å ´æ™¯**ï¼šåœ¨ Admin Data Control Center ç”¨è‡ªç„¶èªè¨€æœå°‹å•†å“/æ–‡ç« 

**UI è¨­è¨ˆ**ï¼š

```
â”Œâ”€ Data Control Center æœå°‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                          â”‚
â”‚  æœå°‹æ¨¡å¼ï¼šâ—‹ é—œéµå­—ï¼ˆç²¾ç¢ºåŒ¹é…ï¼‰  â— èªæ„ï¼ˆæ„ç¾©åŒ¹é…ï¼‰                       â”‚
â”‚                                                                          â”‚
â”‚  [ğŸ” è¼•ä¾¿å¥½æ”œå¸¶çš„æ±è¥¿...]                                                 â”‚
â”‚                                                                          â”‚
â”‚  æœå°‹çµæœï¼š                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ â˜‘ [å•†å“] æ‘ºç–Šæ°´å£º - ç›¸ä¼¼åº¦: 89%                                     â”‚  â”‚
â”‚  â”‚ â˜‘ [å•†å“] éš¨èº«å°åŒ… - ç›¸ä¼¼åº¦: 85%                                     â”‚  â”‚
â”‚  â”‚ â˜ [æ–‡ç« ] æ—…è¡Œå¿…å‚™å°ç‰©æ¨è–¦ - ç›¸ä¼¼åº¦: 78%                              â”‚  â”‚
â”‚  â”‚ â˜ [å•†å“] è¼•é‡åŒ–èƒŒåŒ… - ç›¸ä¼¼åº¦: 75%                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åƒæ•¸è¨­å®š**ï¼š

| åƒæ•¸         | é è¨­å€¼                      | å¯èª¿æ•´ | è¨­å®šä½ç½®                      |
| ------------ | --------------------------- | ------ | ----------------------------- |
| ç›¸ä¼¼åº¦é–¾å€¼   | 0.7ï¼ˆ70%ï¼‰                  | âœ“      | `/admin/settings` AI è¨­å®šå€å¡Š |
| çµæœæ•¸é‡ä¸Šé™ | 20 ç­†                       | âœ“      | `/admin/settings` AI è¨­å®šå€å¡Š |
| æœå°‹ç¯„åœ     | Product, Post, Gallery Item | âœ“      | Data Control Center å³æ™‚é¸æ“‡  |

**æœå°‹ç¯„ä¾‹**ï¼š

| ç”¨æˆ¶è¼¸å…¥       | å¯æ‰¾åˆ°ï¼ˆå‚³çµ±æœå°‹æ‰¾ä¸åˆ°ï¼‰ |
| -------------- | ------------------------ |
| ã€Œé€ç¦®ç”¨çš„ã€   | ç¦®ç›’çµ„åˆã€ç²¾ç¾åŒ…è£å•†å“   |
| ã€Œç’°ä¿æè³ªã€   | å¤©ç„¶çš®é©ã€æœ‰æ©Ÿæ£‰è£½å“     |
| ã€Œé©åˆä¸Šç­æ—ã€ | å•†å‹™é¢¨æ ¼å•†å“             |

### 3.1.1 èªæ„æœå°‹ API å¥‘ç´„

**Server Action**ï¼š

```typescript
// lib/modules/embedding/embedding-search-io.ts
export async function semanticSearch(params: {
  query: string;
  targetTypes?: ("product" | "post" | "gallery_item")[];
  limit?: number; // default: 20
  threshold?: number; // default: 0.7
}): Promise<SemanticSearchResult[]>;

interface SemanticSearchResult {
  targetType: "product" | "post" | "gallery_item";
  targetId: string;
  similarity: number; // 0-1, higher = more similar
  // ä¸å›å‚³å®Œæ•´å…§å®¹ï¼Œç”± caller è‡ªè¡ŒæŸ¥è©¢
}
```

**ä½¿ç”¨ç¯„ä¾‹**ï¼ˆControl Centerï¼‰ï¼š

```typescript
const results = await semanticSearch({
  query: "è¼•ä¾¿å¥½æ”œå¸¶",
  targetTypes: ["product", "gallery_item"],
  threshold: 0.7,
});
// â†’ [{ targetType: 'product', targetId: 'uuid-1', similarity: 0.89 }, ...]
```

### 3.2 ç›¸ä¼¼æ¨è–¦

**ä½¿ç”¨å ´æ™¯**ï¼šå•†å“/æ–‡ç« è©³æƒ…é é¡¯ç¤ºã€Œç›¸ä¼¼é …ç›®ã€

#### 3.2.0 similar_items é è¨ˆç®—è¡¨

> **æ±ºç­–**: ä½¿ç”¨é è¨ˆç®—è¡¨å„²å­˜ç›¸ä¼¼é …ç›®ï¼Œç”±æ¯æ—¥ Cron Job è¨ˆç®—ï¼Œé¿å… query-time è¨ˆç®—å»¶é²ã€‚

```sql
CREATE TABLE similar_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  source_type VARCHAR(50) NOT NULL,    -- 'product' | 'post' | 'gallery_item'
  source_id UUID NOT NULL,
  target_type VARCHAR(50) NOT NULL,    -- Phase 1-5: åŒé¡å‹ï¼›Phase 6+: å¯è·¨é¡å‹
  target_id UUID NOT NULL,
  similarity_score DECIMAL(4,3) NOT NULL,  -- 0.000-1.000
  rank INT NOT NULL,                   -- 1-10 æ’å
  computed_at TIMESTAMPTZ NOT NULL DEFAULT now(),

  UNIQUE(source_type, source_id, target_type, target_id)
);

CREATE INDEX idx_similar_items_source ON similar_items(source_type, source_id, rank);
CREATE INDEX idx_similar_items_computed ON similar_items(computed_at);
```

**è¨­è¨ˆæ±ºç­–**ï¼š

| é …ç›® | æ±ºå®š | ç†ç”± |
|------|------|------|
| Top-N æ•¸é‡ | 10 | è¶³å¤ æ»¿è¶³ã€Œç›¸ä¼¼å•†å“ã€ã€Œç›¸é—œæ–‡ç« ã€ç­‰ UI éœ€æ±‚ |
| Phase 1-5 æ¨è–¦é¡å‹ | åŒé¡å‹ | é™ä½è¨ˆç®—é‡ï¼Œå•†å“æ¨è–¦å•†å“ã€æ–‡ç« æ¨è–¦æ–‡ç«  |
| Phase 6+ æ¨è–¦é¡å‹ | Owner å¯é¸é–‹å•Ÿè·¨é¡å‹ | å¦‚ã€Œè²·é€™åŒ…çš„äººä¹Ÿçœ‹éé€™ç¯‡ä¿é¤Šæ–‡ã€|
| æ›´æ–°ç­–ç•¥ | UPSERT | åƒ…æ›´æ–°æœ‰è®Šæ›´çš„é …ç›®ï¼Œæ¸›å°‘ DB å¯«å…¥ |

**Cron Job è¨ˆç®—æµç¨‹**ï¼š

```
æ¯æ—¥ 03:00 UTC
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æƒæ embeddings â”‚  æ‰¾å‡ºæ‰€æœ‰ target
â”‚  è¡¨              â”‚  ï¼ˆproduct, post, gallery_itemï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å°æ¯å€‹ target   â”‚  è¨ˆç®— Top-10 æœ€ç›¸ä¼¼
â”‚  è¨ˆç®—ç›¸ä¼¼åº¦      â”‚  ï¼ˆé¤˜å¼¦ç›¸ä¼¼åº¦ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UPSERT åˆ°       â”‚  åƒ…æ›´æ–°æœ‰è®Šæ›´çš„è¨˜éŒ„
â”‚  similar_items   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**UI è¨­è¨ˆï¼ˆå•†å“é ï¼‰**ï¼š

```
â”Œâ”€ å•†å“è©³æƒ…ï¼šæ‰‹å·¥çš®é©åŒ… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                           â”‚
â”‚  [åœ–ç‰‡]                                                                   â”‚
â”‚  æ‰‹å·¥çš®é©åŒ…                                                               â”‚
â”‚  NT$3,500                                                                â”‚
â”‚                                                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                           â”‚
â”‚  ğŸ›ï¸ ç›¸ä¼¼å•†å“                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ [åœ–ç‰‡]   â”‚  â”‚ [åœ–ç‰‡]   â”‚  â”‚ [åœ–ç‰‡]   â”‚  â”‚ [åœ–ç‰‡]   â”‚                  â”‚
â”‚  â”‚ çš®é©éŒ¢åŒ… â”‚  â”‚ æ‰‹å·¥æ‰˜ç‰¹ â”‚  â”‚ å¾©å¤èƒŒåŒ… â”‚  â”‚ çš®é©æ‰‹ç’° â”‚                  â”‚
â”‚  â”‚ NT$1,200 â”‚  â”‚ NT$2,800 â”‚  â”‚ NT$3,200 â”‚  â”‚ NT$580   â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¦æ ¼**ï¼š

| é …ç›®     | è¨­å®š                           |
| -------- | ------------------------------ |
| é¡¯ç¤ºæ•¸é‡ | 4 å€‹                           |
| æ’åºä¾æ“š | ç›¸ä¼¼åº¦ç”±é«˜åˆ°ä½                 |
| æ’é™¤æ¢ä»¶ | è‡ªå·±ã€å·²ä¸‹æ¶å•†å“               |
| ç„¡çµæœæ™‚ | é¡¯ç¤ºåŒåˆ†é¡ç†±é–€å•†å“ï¼ˆfallbackï¼‰ |

**Fallback é‚è¼¯**ï¼š

| æ¢ä»¶                       | åˆ¤æ–·   | é¡¯ç¤ºå…§å®¹      |
| -------------------------- | ------ | ------------- |
| ç›¸ä¼¼åº¦ â‰¥ 70% çš„çµæœ â‰¥ 1 ç­† | æ­£å¸¸   | ç›¸ä¼¼å•†å“/æ–‡ç«  |
| ç›¸ä¼¼åº¦ â‰¥ 70% çš„çµæœ = 0 ç­† | ç„¡çµæœ | é€²å…¥ Fallback |

**Fallback é †åº**ï¼š

1. **åŒåˆ†é¡ç†±é–€**ï¼šè©²åˆ†é¡ä¸­çš„ç†±é–€å•†å“ï¼ˆé å…ˆè¨ˆç®—ï¼‰
2. **åŒåˆ†é¡ä¹Ÿç„¡å•†å“**ï¼šå…¨ç«™ç†±é–€å•†å“ï¼ˆé å…ˆè¨ˆç®—ï¼‰
3. **å…¨ç«™ä¹Ÿç„¡å•†å“**ï¼šä¸é¡¯ç¤ºã€Œç›¸ä¼¼å•†å“ã€å€å¡Š

**ã€Œç†±é–€ã€è¨ˆç®—æ–¹å¼ï¼ˆæ•ˆèƒ½å„ªåŒ–ï¼‰**ï¼š

| é …ç›®         | æ–¹å¼                                                     |
| ------------ | -------------------------------------------------------- |
| è¨ˆç®—æ™‚æ©Ÿ     | æ¯æ—¥å‡Œæ™¨ Cron Jobï¼ˆä¸å³æ™‚è¨ˆç®—ï¼‰                          |
| å„²å­˜ä½ç½®     | `products.popularity_rank`ã€`posts.popularity_rank` æ¬„ä½ |
| å•†å“ç†±é–€å…¬å¼ | éå» 30 å¤©éŠ·é‡                                           |
| æ–‡ç« ç†±é–€å…¬å¼ | éå» 30 å¤©ï¼ˆç•™è¨€æ•¸ Ã— 2 + æŒ‰è®šæ•¸ï¼‰                        |
| Client æŸ¥è©¢  | ç›´æ¥ `ORDER BY popularity_rank LIMIT 4`ï¼Œç„¡éœ€è¨ˆç®—        |

**UI è¨­è¨ˆï¼ˆæ–‡ç« é ï¼‰**ï¼š

```
â”Œâ”€ ç›¸é—œæ–‡ç«  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                           â”‚
â”‚  ğŸ“– ä½ å¯èƒ½ä¹Ÿæœƒå–œæ­¡                                                         â”‚
â”‚                                                                           â”‚
â”‚  â€¢ çš®é©ä¿é¤Šå°çŸ¥è­˜ - 2025/01/15                                            â”‚
â”‚  â€¢ æ‰‹å·¥è—å“çš„æ•…äº‹ - 2025/01/10                                            â”‚
â”‚  â€¢ å¦‚ä½•æŒ‘é¸è³ªæ„Ÿå¥½ç‰© - 2025/01/05                                          â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2.1 ç›¸ä¼¼æ¨è–¦ Cache ç­–ç•¥

| é …ç›®         | è¨­å®š                                      |
| ------------ | ----------------------------------------- |
| Cache å±¤ç´š   | ä½¿ç”¨ `cachedQuery` åŒ…è£                   |
| Cache Tag    | `similar-{targetType}-{targetId}`         |
| TTL          | ç”± `cachedQuery` è‡ªå‹•ç®¡ç†                 |
| Invalidation | ç•¶è©²å•†å“/æ–‡ç«  embedding æ›´æ–°æ™‚ revalidate |

**åŸå› **ï¼š

- ç›¸ä¼¼æ¨è–¦çµæœç›¸å°ç©©å®šï¼ˆé™¤éå…§å®¹è®Šæ›´ï¼‰
- é¿å…æ¯æ¬¡é é¢è¼‰å…¥éƒ½æŸ¥è©¢ vector DB
- å•†å“é  LCP ä¸æ‡‰å— embedding æŸ¥è©¢å»¶é²å½±éŸ¿

### 3.3 RAGï¼ˆæª¢ç´¢å¢å¼·ç”Ÿæˆï¼‰

**ä½¿ç”¨å ´æ™¯**ï¼šAI åˆ†ææ™‚ï¼Œè‡ªå‹•æ‰¾å‡ºç›¸é—œè³‡æ–™ä½œç‚ºä¸Šä¸‹æ–‡

**é‹ä½œæµç¨‹**ï¼š

```
ç”¨æˆ¶è«‹æ±‚ï¼šã€Œåˆ†ææœ€è¿‘ç†±è³£çš„å•†å“ç‰¹å¾µã€
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  èªæ„æœå°‹    â”‚  æ‰¾å‡ºèˆ‡ã€Œç†±è³£å•†å“ç‰¹å¾µã€ç›¸é—œçš„ embedding
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æª¢ç´¢è³‡æ–™    â”‚  å–å¾—é€™äº›å•†å“çš„å®Œæ•´è³‡æ–™ï¼ˆåç¨±ã€æè¿°ã€éŠ·å”®æ•¸æ“šï¼‰
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  çµ„åˆ Prompt â”‚  å°‡ç›¸é—œè³‡æ–™ä½œç‚ºä¸Šä¸‹æ–‡ + åˆ†ææŒ‡ä»¤
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  å‘¼å« LLM    â”‚  ç”Ÿæˆåˆ†æå ±å‘Š
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å„ªå‹¢æ¯”è¼ƒ**ï¼š

| é …ç›®       | å‚³çµ±æ–¹å¼            | RAG æ–¹å¼               |
| ---------- | ------------------- | ---------------------- |
| å‚³é€è³‡æ–™é‡ | å…¨éƒ¨å•†å“è³‡æ–™        | åƒ…ç›¸é—œå•†å“ï¼ˆ10-20 ç­†ï¼‰ |
| Token ç”¨é‡ | ~15,000 tokens      | ~8,000 tokens          |
| æˆæœ¬       | $0.45               | $0.24ï¼ˆç¯€çœ 47%ï¼‰      |
| ç²¾æº–åº¦     | AI å¯èƒ½å¿½ç•¥é‡è¦ç´°ç¯€ | AI å°ˆæ³¨æ–¼ç›¸é—œè³‡æ–™      |

**UI è¨­è¨ˆï¼ˆAI åˆ†æè¨­å®šï¼‰**ï¼š

```
â”Œâ”€ AI åˆ†æè¨­å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                           â”‚
â”‚  åˆ†ææ¨¡å¼ï¼š                                                               â”‚
â”‚  â—‹ æ¨™æº–æ¨¡å¼ï¼ˆå‚³é€å…¨éƒ¨è³‡æ–™ï¼‰                                               â”‚
â”‚  â— RAG æ¨¡å¼ï¼ˆæ™ºèƒ½æª¢ç´¢ç›¸é—œè³‡æ–™ï¼‰â† æ¨è–¦                                     â”‚
â”‚                                                                           â”‚
â”‚  é ä¼°æ¯”è¼ƒï¼š                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ æ¨™æº–æ¨¡å¼ï¼š~15,000 tokens = $0.45                                    â”‚  â”‚
â”‚  â”‚ RAG æ¨¡å¼ï¼š~8,000 tokens = $0.24  âœ“ ç¯€çœ 47%                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. è‡ªå‹•æ›´æ–°æ©Ÿåˆ¶

### 4.1 è§¸ç™¼æ™‚æ©Ÿ

| äº‹ä»¶                  | å‹•ä½œ                    | å‚™è¨»     |
| --------------------- | ----------------------- | -------- |
| å•†å“æ–°å¢              | ç”Ÿæˆ embedding          | å³æ™‚è§¸ç™¼ |
| å•†å“æ›´æ–°              | é‡æ–°ç”Ÿæˆ embedding      | å³æ™‚è§¸ç™¼ |
| æ–‡ç« ç™¼å¸ƒ              | ç”Ÿæˆ embedding          | å³æ™‚è§¸ç™¼ |
| æ–‡ç« æ›´æ–°              | é‡æ–°ç”Ÿæˆ embedding      | å³æ™‚è§¸ç™¼ |
| Gallery ä½œå“æ–°å¢/æ›´æ–° | ç”Ÿæˆ/é‡æ–°ç”Ÿæˆ embedding | å³æ™‚è§¸ç™¼ |
| ç•™è¨€æ–°å¢              | ç”Ÿæˆ embedding          | å³æ™‚è§¸ç™¼ |
| å…§å®¹åˆªé™¤              | åˆªé™¤å°æ‡‰ embedding      | å³æ™‚è§¸ç™¼ |

> **ã€Œå³æ™‚è§¸ç™¼ã€å®šç¾©**ï¼šæŒ‡ç«‹å³å¯«å…¥ `embedding_queue`ï¼ˆpriority = highï¼‰ï¼Œç”± Edge Function éåŒæ­¥è™•ç†ã€‚å–®ç­†ç·¨è¼¯é€šå¸¸åœ¨ 10-20 ç§’å…§å®Œæˆ embedding ç”Ÿæˆã€‚æ­¤è¨­è¨ˆç¢ºä¿ Admin ç·¨è¼¯æ“ä½œä¸æœƒè¢« embedding ç”Ÿæˆé˜»å¡ã€‚

### 4.2 æ‰¹æ¬¡åˆå§‹åŒ–

**ä½¿ç”¨å ´æ™¯**ï¼šé¦–æ¬¡å•Ÿç”¨åŠŸèƒ½æ™‚ï¼Œç‚ºæ‰€æœ‰ç¾æœ‰è³‡æ–™å»ºç«‹ embedding

**åŸ·è¡Œæ–¹å¼**ï¼š

- Admin UI æä¾›ã€Œåˆå§‹åŒ– Embeddingã€æŒ‰éˆ•
- èƒŒæ™¯åŸ·è¡Œï¼Œé¡¯ç¤ºé€²åº¦æ¢
- é ä¼°æ™‚é–“ï¼š650 ç­†ç´„ 2-3 åˆ†é˜

**UI è¨­è¨ˆ**ï¼š

```
â”Œâ”€ Embedding ç®¡ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                           â”‚
â”‚  ç‹€æ…‹ï¼š                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Products: 50/50 âœ“                                                   â”‚  â”‚
â”‚  â”‚ Posts: 98/100 (2 ç­†å¤±æ•—)                                            â”‚  â”‚
â”‚  â”‚ Gallery Items: 30/30 âœ“                                              â”‚  â”‚
â”‚  â”‚ Comments: 470/500 (é€²è¡Œä¸­...)                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                           â”‚
â”‚  [é‡å»ºå…¨éƒ¨ Embedding]  [é‡è©¦å¤±æ•—é …ç›®]                                      â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 æ‰¹é‡åŒ¯å…¥å¾Œçš„ Embedding ç”Ÿæˆç­–ç•¥

ç•¶ Module Aï¼ˆImport/Exportï¼‰å®Œæˆæ‰¹é‡åŒ¯å…¥å¾Œï¼Œéœ€è¦ç‚ºæ–°è³‡æ–™ç”Ÿæˆ embeddingã€‚

**è§¸ç™¼æ©Ÿåˆ¶**ï¼šQueue è¡¨è¼ªè©¢ï¼ˆè§£è€¦æ¶æ§‹ï¼‰+ Cron Job

> **æ±ºç­–**: æ¡ç”¨ã€Œæ¯ 1 å°æ™‚è¼ªè©¢ + æ¯æ—¥ Cronã€æ¨¡å¼ï¼Œå¹³è¡¡æˆæœ¬èˆ‡å³æ™‚æ€§ã€‚

```
åŒ¯å…¥è³‡æ–™å¯«å…¥ DB
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Next.js Action   â”‚  åŒ¯å…¥å®Œæˆå¾Œå¯«å…¥ embedding_queue
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  embedding_queue  â”‚  å„²å­˜å¾…è™•ç†é …ç›®ï¼ˆpriority + statusï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  â”‚ æ’ç¨‹ç­–ç•¥ï¼š                              â”‚
         â”‚  â”‚ â€¢ æ¯ 1 å°æ™‚è¼ªè©¢ pending é …ç›®            â”‚
         â”‚  â”‚ â€¢ æ¯æ—¥ 03:00 UTC å…¨é¢æƒææ¼ç¶²ä¹‹é­š       â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Edge Function    â”‚  Supabase Cron Job
â”‚  (batch-embed)    â”‚  å„ªå…ˆè™•ç† priority='high'ï¼Œæ¯æ‰¹ 10 ç­†
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  OpenAI API       â”‚  ç”Ÿæˆ embedding
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  embeddings è¡¨    â”‚  å¯«å…¥çµæœ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é¸ç”¨ Queue è¼ªè©¢çš„åŸå› **ï¼š

| å„ªé»     | èªªæ˜                                           |
| -------- | ---------------------------------------------- |
| è§£è€¦     | Next.js åŒ¯å…¥å®Œæˆå¾Œç«‹å³è¿”å›ï¼Œä¸ç­‰å¾… embedding   |
| å¯æ§     | å¯èª¿æ•´æ‰¹æ¬¡å¤§å°ã€è¼ªè©¢é–“éš”ã€é‡è©¦ç­–ç•¥             |
| ç©©å®š     | ä¸å½±éŸ¿ä¸»è¡¨å¯«å…¥æ•ˆèƒ½ï¼ˆç„¡ Database Trigger é–‹éŠ·ï¼‰ |
| å¤±æ•—é‡è©¦ | ç°¡å–®é‡è¨­ status = pending å³å¯                 |
| çœéŒ¢     | 1 å°æ™‚è¼ªè©¢ vs 10 ç§’è¼ªè©¢ï¼ŒAPI å‘¼å«æ¬¡æ•¸å¤§å¹…é™ä½  |

**ä½‡åˆ—è¡¨è¨­è¨ˆ**ï¼š

```sql
CREATE TABLE embedding_queue (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  target_type VARCHAR(50) NOT NULL,
  target_id UUID NOT NULL,
  priority VARCHAR(10) DEFAULT 'normal',  -- 'high' | 'normal' | 'low'
  status VARCHAR(20) DEFAULT 'pending',   -- pending, processing, completed, failed
  attempts INT DEFAULT 0,
  error_message TEXT,
  quality_status VARCHAR(20),             -- passed, incomplete, failed
  processing_metadata JSONB,              -- è™•ç†éç¨‹ metadata
  created_at TIMESTAMPTZ DEFAULT now(),
  processed_at TIMESTAMPTZ,

  UNIQUE(target_type, target_id)
);

-- æ•ˆèƒ½ç´¢å¼•ï¼šEdge Function è¼ªè©¢æ™‚å„ªå…ˆè™•ç† high priority å’Œ pending status
CREATE INDEX idx_embedding_queue_status ON embedding_queue(status, priority DESC, created_at);
```

**Cron Job æ’ç¨‹**ï¼š

| Job åç¨± | æ’ç¨‹ | èªªæ˜ |
|----------|------|------|
| `embedding-hourly` | æ¯å°æ™‚ | è™•ç† pending é …ç›®ï¼Œå„ªå…ˆ high priority |
| `embedding-daily-sweep` | æ¯æ—¥ 03:00 UTC | æƒææ¼ç¶²ä¹‹é­šï¼Œæª¢æŸ¥æ¥­å‹™è¡¨èˆ‡ embeddings è¡¨å·®ç•° |
| `similar-items-daily` | æ¯æ—¥ 04:00 UTC | è¨ˆç®—/æ›´æ–° similar_items è¡¨ |
| `quality-audit-weekly` | æ¯é€±æ—¥ 05:00 UTC | æŠ½æ¨£å“è³ªæª¢æŸ¥ï¼ˆPhase 6+ï¼‰ |

**è™•ç†è¦å‰‡**ï¼š

| é …ç›®     | è¨­å®š                              |
| -------- | --------------------------------- |
| æ‰¹æ¬¡å¤§å° | 10 ç­†/æ¬¡                          |
| è¼ªè©¢é–“éš” | 1 å°æ™‚                            |
| æœ€å¤§é‡è©¦ | 3 æ¬¡                              |
| é‡è©¦é–“éš” | æŒ‡æ•¸é€€é¿ï¼ˆ1h, 3h, 9hï¼‰            |
| å¤±æ•—è™•ç† | æ¨™è¨˜ç‚º `failed`ï¼ŒAdmin å¯æ‰‹å‹•é‡è©¦ |

**ä¼°ç®—ï¼ˆ100 ç­†åŒ¯å…¥ï¼‰**ï¼š

- å¯«å…¥ä½‡åˆ—ï¼šå³æ™‚
- Embedding ç”Ÿæˆï¼šæœ€é² 1 å°æ™‚å…§é–‹å§‹è™•ç†ï¼Œç´„ 10-20 åˆ†é˜å®Œæˆ
- ä½¿ç”¨è€…å¯ç«‹å³æ“ä½œï¼Œä¸éœ€ç­‰å¾… embedding å®Œæˆ

---

## 5. éŒ¯èª¤è™•ç†

### 5.1 Embedding ç”Ÿæˆå¤±æ•—

| æƒ…æ³                  | è™•ç†æ–¹å¼                     |
| --------------------- | ---------------------------- |
| OpenAI API æš«æ™‚ä¸å¯ç”¨ | è‡ªå‹•é‡è©¦ 3 æ¬¡ï¼ˆæŒ‡æ•¸é€€é¿ï¼‰    |
| è¶…é rate limit       | ç­‰å¾…å¾Œé‡è©¦                   |
| å…§å®¹éé•·              | è‡ªå‹•æˆªæ–·ï¼ˆå–å‰ 8000 tokensï¼‰ |
| æŒçºŒå¤±æ•—              | æ¨™è¨˜ç‚ºå¤±æ•—ï¼Œé€šçŸ¥ Owner       |

**å…§å®¹é•·åº¦èªªæ˜**ï¼š

| é …ç›®                | èªªæ˜                                           |
| ------------------- | ---------------------------------------------- |
| OpenAI ada-002 ä¸Šé™ | 8,191 tokens                                   |
| æœ¬ç³»çµ±æˆªæ–·é»        | 8,000 tokensï¼ˆä¿ç•™ bufferï¼‰                    |
| ä¸­æ–‡ä¼°ç®—            | ç´„ 1.5 tokens/å­— â†’ ç´„ 5,300 å­—                 |
| è‹±æ–‡ä¼°ç®—            | ç´„ 0.25 tokens/å­— â†’ ç´„ 32,000 å­—               |
| æˆªæ–·é€šçŸ¥            | ä¸ä¸»å‹•é€šçŸ¥ï¼ˆå› ç‚ºæˆªæ–·å¾ˆç½•è¦‹ï¼Œä¸”æ‘˜è¦é€šå¸¸å·²è¶³å¤ ï¼‰ |

**å¯¦éš›å½±éŸ¿**ï¼š

- å•†å“æè¿°é€šå¸¸ < 500 å­—ï¼Œä¸æœƒè§¸ç™¼æˆªæ–·
- æ–‡ç« åªå–æ¨™é¡Œ + æ‘˜è¦ï¼Œä¸æœƒè§¸ç™¼æˆªæ–·
- ç•™è¨€é€šå¸¸ < 200 å­—ï¼Œä¸æœƒè§¸ç™¼æˆªæ–·

### 5.2 æœå°‹å¤±æ•—æ™‚çš„ Fallback

| æƒ…æ³                 | Fallback             |
| -------------------- | -------------------- |
| èªæ„æœå°‹ç„¡çµæœ       | åˆ‡æ›åˆ°é—œéµå­—æœå°‹     |
| Embedding æœå‹™ä¸å¯ç”¨ | è‡ªå‹•åˆ‡æ›åˆ°é—œéµå­—æœå°‹ |
| ç›¸ä¼¼æ¨è–¦ç„¡çµæœ       | é¡¯ç¤ºåŒåˆ†é¡ç†±é–€é …ç›®   |

### 5.2.1 Phase 5 å‰çš„è¡Œç‚ºï¼ˆEmbedding æœªå•Ÿç”¨ï¼‰

| åŠŸèƒ½                | Phase 5 å‰è¡Œç‚º                              |
| ------------------- | ------------------------------------------- |
| Control Center æœå°‹ | åƒ…é¡¯ç¤ºã€Œé—œéµå­—ã€æ¨¡å¼ï¼Œã€Œèªæ„ã€æ¨¡å¼ disabled |
| å•†å“é ç›¸ä¼¼å•†å“      | é¡¯ç¤ºåŒåˆ†é¡ç†±é–€å•†å“ï¼ˆfallbackï¼‰              |
| æ–‡ç« é ç›¸é—œæ–‡ç«       | é¡¯ç¤ºåŒåˆ†é¡æœ€æ–°æ–‡ç« ï¼ˆfallbackï¼‰              |
| AI åˆ†æ RAG æ¨¡å¼    | é¸é …ä¸é¡¯ç¤º                                  |

**åˆ¤æ–·æ©Ÿåˆ¶**ï¼šæª¢æŸ¥ `embeddings` è¡¨æ˜¯å¦æœ‰è³‡æ–™

```typescript
// lib/modules/embedding/embedding-status-io.ts
export async function isSemanticSearchEnabled(): Promise<boolean> {
  const { count } = await supabase
    .from("embeddings")
    .select("*", { count: "exact", head: true });
  return (count ?? 0) > 0;
}
```

> **UI Hint**: èªæ„æœå°‹é¸é …æ—é¡¯ç¤º tooltip: "éœ€å®Œæˆ Embedding åˆå§‹åŒ–"

### 5.3 ç›£æ§æŒ‡æ¨™

| æŒ‡æ¨™                      | è­¦å‘Šé–¾å€¼ | å‹•ä½œ               |
| ------------------------- | -------- | ------------------ |
| Embedding ç”Ÿæˆå¤±æ•—ç‡      | > 5%     | é€šçŸ¥ Owner         |
| æœå°‹å»¶é²                  | > 2 ç§’   | æª¢æŸ¥ç´¢å¼•           |
| ç¼ºå°‘ Embedding çš„è³‡æ–™æ¯”ä¾‹ | > 10%    | æç¤ºé‡è·‘æ‰¹æ¬¡åˆå§‹åŒ– |

---

## 5.5 æŠ€è¡“æ¨¡çµ„çµæ§‹ï¼ˆä¾å¾ª ARCHITECTURE.mdï¼‰

```
lib/
â”œâ”€â”€ embedding/
â”‚   â”œâ”€â”€ io.ts                    # Embedding IO facadeï¼ˆæ¨™è¨˜ server-onlyï¼‰
â”‚   â”œâ”€â”€ embedding-generate-io.ts # å‘¼å« OpenAI API ç”Ÿæˆ embedding
â”‚   â”œâ”€â”€ embedding-search-io.ts   # èªæ„æœå°‹ / ç›¸ä¼¼åº¦æŸ¥è©¢
â”‚   â”œâ”€â”€ embedding-batch-io.ts    # æ‰¹æ¬¡åˆå§‹åŒ–
â”‚   â””â”€â”€ embedding-pure.ts        # ç´”å‡½å¼ï¼ˆæ–‡å­—çµ„åˆã€HTML stripã€æˆªæ–·é‚è¼¯ï¼‰
â”œâ”€â”€ types/
â”‚   â””â”€â”€ embedding.ts             # Embedding types
â””â”€â”€ validators/
    â””â”€â”€ embedding.ts             # è¼¸å…¥é©—è­‰ï¼ˆç´”å‡½å¼ï¼‰

supabase/functions/
â””â”€â”€ generate-embedding/          # Edge Functionï¼ˆå‘¼å« OpenAI APIï¼‰
    â””â”€â”€ index.ts
```

**æ¶æ§‹ç´„æŸå°æ‡‰**ï¼š

| ç´„æŸï¼ˆfrom ARCHITECTURE.mdï¼‰ | æœ¬åŠŸèƒ½å°æ‡‰                                                                                         |
| ---------------------------- | -------------------------------------------------------------------------------------------------- |
| IO boundariesï¼ˆÂ§3.4ï¼‰        | æ‰€æœ‰ DB/API æ“ä½œåœ¨ `lib/modules/embedding/*-io.ts`                                                         |
| IO module sizeï¼ˆÂ§3.4ï¼‰       | æ¯å€‹ `*-io.ts` æª”æ¡ˆä¸è¶…é 300 è¡Œï¼ˆé ä¼°å„æª”ç´„ 80-120 è¡Œï¼‰                                           |
| Server-onlyï¼ˆÂ§4.5, Â§4.6ï¼‰    | æ‰€æœ‰ IO æª”æ¡ˆé–‹é ­å¿…é ˆ `import 'server-only';`                                                       |
| Validatorsï¼ˆÂ§3.6ï¼‰           | è¼¸å…¥é©—è­‰æ”¾ `lib/validators/embedding.ts`ï¼ˆç´”å‡½å¼ï¼‰                                                 |
| Edge Function                | OpenAI API Key å­˜æ–¼ Supabase Secretsï¼Œåƒ… Edge Function å¯å­˜å–                                      |
| **SDK Server-only**          | OpenAI SDK åƒ…åœ¨ Edge Function (`supabase/functions/generate-embedding/`) ä½¿ç”¨ï¼Œä¸é€² Next.js bundle |

---

## 6. å®‰å…¨æ€§

### 6.1 API Key ç®¡ç†

- OpenAI API Key é€é **Supabase Dashboard â†’ Project Settings â†’ Edge Functions â†’ Secrets** è¨­å®š
- ä¸éœ€è¦ä»»ä½• Admin UI è¨­å®šé é¢ï¼ˆè³‡å®‰è€ƒé‡ï¼‰
- æ°¸ä¸æš´éœ²çµ¦å‰ç«¯ï¼Œåƒ… Edge Function å¯å­˜å–

### 6.2 å­˜å–æ§åˆ¶

| æ“ä½œ                | æ¬Šé™                         |
| ------------------- | ---------------------------- |
| èªæ„æœå°‹            | Admin èªè­‰ï¼ˆOwner / Editorï¼‰ |
| æŸ¥çœ‹ Embedding ç‹€æ…‹ | Owner only                   |
| é‡å»º Embedding      | Owner only                   |

### 6.3 è³‡æ–™éš±ç§

| é …ç›®           | è¦å‰‡               |
| -------------- | ------------------ |
| ç•™è¨€ embedding | ä¸åŒ…å«ä½¿ç”¨è€… email |
| è¨‚å–®è³‡æ–™       | ä¸å»ºç«‹ embedding   |
| æœƒå“¡è³‡æ–™       | ä¸å»ºç«‹ embedding   |

---
